

## 术语表

| **术语 (Term)**               | **定义 (Definition)**                                        |
| ------------------------------| ------------------------------------------------------------ |
| **Sync_Event (同步事件)**     | 系统内部传递的一种控制指令包，用于强制统一房间内的播放状态。包含指令类型（SEEK, PAUSE, PLAY, CHANGE_RATE, CHANGE_SOURCE等）和参数Payload（时间戳/速率/视频源） |
| **CHANGE_RATE (变速)**        | `Sync_Event` 类型。管理员修改了播放速率。Payload 包含新的速率因子（如 1.5, 2.0）。客户端接收后必须调整本地播放器的 播放速率。 |
| **SEEK (跳转)**               | `Sync_Event` 类型。Payload 包含目标时间戳（毫秒）。          |
| **PAUSE / PLAY (启停)**       | `Sync_Event` 类型。指示播放器暂停或开始。                    |
| **CHANGE_SUBTITLE (更改字幕)**| `Sync_Event` 类型。管理员更换了播放内容。Payload 包含新的视频 URL、视频标题及初始字幕信息。客户端接收后需重置播放器并加载新资源。 |
|                               |                                                              |
| **同步阈值**                 | 系统允许的最大时间误差值（例如 2000 毫秒）。超过此值的偏差被视为“不同步”，必须触发强制跳转逻辑。 |
| **本地属性**                 | 指音量和 清晰度。这些属性由观众端独立控制，系统严禁将其同步给其他用户。 |
| **房间状态对象**             | 服务器维护的关于房间当前情况的唯一真实数据集合，用于新用户进房时的初始化同步。（包含：正在播放的视频资源标识、全局基准时间戳、当前播放状态、当前字幕轨道） |
|                              |                                                              |
| **操作时间戳**                | 记录控制操作发生时刻的唯一时间标识。用于解决操作冲突、保证操作顺序以及进行日志记录 。|
| **审计日志**                  | 系统为每一次控制操作记录的不可篡改的日志，通常包含操作者、操作类型、操作时间、操作参数等信息，用于安全审计和问题追踪 。|
| **状态恢复机制**              | 当用户因网络问题暂时断开连接并重连后，系统能够自动将其播放器状态（进度、播放/暂停等）恢复到与当前房间状态对象一致的流程。 |







## 控制放映视频（ID：UC-R05)

### *简要描述*

- 该用例描述了管理员如何对当前房间内正在播放的视频进行控制操作（如播放、暂停、更改进度，控制播放倍速，以及更换字幕），并且该操作将通过 Sync_Event 实时同步给房间内的所有其他用户，本地属性（如清晰度与音量）由用户独立控制，不在此同步范围内。

### *参与者*

- 房间管理员

### *前置条件*

1.	观影房间存在
2.	视频播放器成功加载并准备好播放一个有效的视频源
3.	房间管理员与系统之间的通信连接正常


### *基本事件流*

1. **执行控制操作**： 管理员执行 “播放”/“暂停”、更改进度、控制播放倍速、更换字幕等控制操作，系统将根据操作类型执行相应的子流。
2. **执行验证操作**： 系统执行子流6.1{验证控制权限}、连接状态、和操作有效性
3. **系统处理状态变更**： 验证通过后，系统更新房间状态对象，并执行子流6.2{记录审计日志}。
4. **系统广播同步事件**：系统根据房间状态对象生成 Sync_Event，并将其广播给房间内所有其他用户。
5. **系统同步状态**： 通过广播的 Sync_Event，系统将其他用户的播放状态同步至指令所指定的状态。
6. 用例结束。

### *备选流* 

**A1.{验证失败}**

- 在基本流步骤2中，如果系统验证失败（权限不足、连接异常或操作无效）：
1.	系统向管理员显示相应的错误信息
2.	系统不执行任何状态变更操作
3.	用例终止


**A2. {房间状态对象异常}**

- 在基本流步骤3中，系统发现房间状态对象损坏、丢失或处于无法更新的非法状态，则：
1.	系统终止当前操作，并向管理员发送“系统状态异常，请稍后重试”的错误信息
2.	系统尝试根据最新的审计日志重建房间状态对象
3.	用例终止

**A3. {同步过程失败}**

- 在基本流步骤5中，如果部分用户同步失败： 
1.	系统记录同步异常日志
2.	对于同步失败的用户，系统在其重新连接时提供状态恢复机制：
    - 如果重新连接成功，用例恢复到基本流 
    - 如果重新连接失败，则提示相应的错误信息，用例终止


**A4.{时间偏差超过同步阈值}**

- 在基本流步骤5中，如果在同步后检测到其他用户其本地播放时间戳与 Sync_Event 中的时间戳偏差超过 同步阈值：
1.	该用户的播放器将立即执行强制跳转，将进度修正到 Sync_Event 指定的时间戳。
2.	系统可记录此事件到审计日志用于服务质量监控。
3.	用例恢复到基本流。


### *子流*

**S1.{验证管理员权限}**

1.	系统检查当前用户是否具有房间管理员角色
2.	系统确认该管理员对当前视频资源有操作权限
3.	返回验证结果（成功/失败）

**S2.{记录审计日志}**

1.	系统组装完整的审计日志条目
2.	系统将日志条目持久化至安全存储
3.	返回记录结果

**S3.{处理播放/暂停操作}**

1.	系统根据操作类型更新房间状态对象的播放状态（播放/暂停）
2.	生成对应的 Sync_Event，指令类型为 PLAY/PAUSE
3.	返回处理结果

**S4.{处理跳转操作}**

1.	系统验证目标时间戳的有效性（在视频时长范围内）
2.	更新房间状态对象的当前播放时间戳
3.	生成对应的 Sync_Event，指令类型为 SEEK，参数为时间戳
4.	返回处理结果

**S5.{处理倍速控制}**

1.	系统验证倍速率值的有效性（如 0.5, 1.0, 1.5, 2.0等）
2.	更新房间状态对象的播放倍速
3.	生成对应的 Sync_Event，指令类型为 CHANGE_RATE，参数为倍速
4.	返回处理结果

**S6.{处理字幕切换}**

1.	系统验证字幕轨道标识的有效性
2.	更新房间状态对象的当前字幕轨道
3.	生成对应的 Sync_Event，指令类型为 CHANGE_SUBTITLE，参数为轨道标识
4.	返回处理结果


### *后置条件*

1.	房间状态对象已按照管理员操作更新
2.	房间内所有其他用户的播放器状态通过 Sync_Event 实现同步，时间偏差在同步阈值之内
3.	所有同步成功的用户，其本地播放状态与房间状态对象一致
4.	系统记录了本次控制操作的审计日志

### *业务规则*

1.	时间偏差超过同步阈值必须强制同步
2.	本地属性禁止同步
