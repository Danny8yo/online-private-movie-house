# 用例 UC-U01：加入观影室（Join Viewing Room）

## 1. 用例名称
加入观影室（Join Viewing Room）  
ID：UC-U01

## 2. 简要描述
本用例描述用户向系统请求加入现有观影室时，系统如何根据业务规则验证房间有效性、访问权限与房间当前状态，并为用户建立必要的实时同步会话，使其进入房间并参与协同观影。

系统在后台将执行多项关键内部动作，包括：解析房间标识、加载房间元数据、校验访问控制策略、检查用户加入资格、建立会话上下文、创建实时通信连接、同步房间状态、记录加入事件等。这些行为虽为系统内部逻辑，但对用户加入流程的正确性与系统一致性至关重要。

## 3. 参与者
- **主要参与者：** 用户  
- **次要参与者：** 无

## 4. 前置条件
- 用户已通过身份认证并处于登录状态。  
- 房间注册表、同步模块、数据库等系统组件保持正常运行并可响应请求。  
- 若用户通过加入令牌进入，则令牌必须有效且未过期。  
- 系统未处于维护模式或限流模式。

## 5. 基本事件流
1. **用例启动：** 用户提交加入观影室请求。该请求可能来自扫码、房间 ID 输入、邀请链接点击等渠道。  
2. 系统接收并解析用户提供的房间标识（Room ID 或加入令牌），并查询房间注册表加载房间元数据（状态、配置、访问策略等）。  
3. 系统执行 **子流 S1：验证加入条件**，包括房间状态检查、访问策略验证、人数上限校验、用户权限验证等。  
4. 验证成功后，系统为用户创建 **房间级会话上下文**，其中包含：用户角色、加入时间、权限集合、设备标识、连接偏好、同步状态占位符等信息。  
5. 系统执行 **子流 S2：初始化实时通信通道**，建立 WebSocket 或等价机制，并返回连接参数与会话标识。  
6. 系统将用户加入房间的同步广播组（Sync Group），并将房间当前播放状态（视频资源、播放进度、字幕轨道、倍速、播放方式等）推送给用户以实现初始状态对齐。  
7. 系统向用户返回加入成功响应，并在必要时触发广播（如“成员加入”事件）通知房间其他参与者。  
8. 用例结束。

## 6. 备选流

### A1. 房间不存在
1. 在子流 S1 中，系统未找到对应房间 ID 或房间记录已被删除。  
2. 系统向用户返回“房间不存在”错误，并停止流程。  
3. 用例失败。

### A2. 房间不可加入
1. 房间状态为关闭、锁定、仅限房主邀请或已满员等。  
2. 系统根据具体原因返回相应错误信息。  
3. 用例失败。

### A3. 用户无加入权限
1. 系统检测到用户不满足访问控制策略，例如：  
   - 不在允许的访问名单中  
   - 标记为封禁状态  
   - 加入令牌无效或已过期  
2. 系统拒绝加入并返回权限错误提示。  
3. 用例失败。

## 7. 子流

### S1. 验证加入条件
1. 系统检查房间是否存在，并加载房间基本信息与访问控制策略。  
2. 系统读取房间状态，包括开放、关闭、锁定或限制加入。  
3. 系统依据访问控制策略验证用户加入资格：  
   - 检查加入令牌有效性  
   - 判断是否在房主黑名单  
   - 校验房间人数是否达到上限  
   - 检查是否处于允许的设备类型范围  
4. 若验证通过，返回基本流；若任一条件失败，触发相应备选流。

### S2. 初始化实时通信通道
1. 系统为用户创建 WebSocket（或等价协议）会话，用于播放同步、事件交互与房间控制命令分发。  
2. 系统记录加入事件日志：时间、用户 ID、房间 ID、设备、网络等元信息。  
3. 系统将该会话加入房间同步组，并立即推送房间当前播放状态（RoomState），确保新加入用户同步视图与已有成员一致。  
4. 返回基本流继续执行。

## 8. 后置条件
- 用户成功建立与房间的实时通信会话。  
- 用户已加入同步组并可实时接收播放同步和房间事件。  
- 房间参与者列表更新。  
- 系统已记录加入日志，便于审计、分析与故障追踪。

---

# 加入观影室术语表（Glossary - UC-U01）

| 术语                          | 定义                                                         | 备注                             |
| ----------------------------- | ------------------------------------------------------------ | -------------------------------- |
| 房间标识（Room ID）           | 系统用于定位观影室的唯一标识字符串。                         | 系统自动生成并在数据库中索引。   |
| 访问控制策略                  | 限制用户加入房间的业务规则，如公开、邀请制、黑名单、人数限制等。 | 在 S1 中验证。                   |
| 房间状态（Room Status）       | 房间是否开放、锁定、关闭或限制加入。                         | 决定加入流程能否继续。           |
| 加入资格（Join Eligibility）  | 用户是否具有进入该房间的权限。                               | 包含令牌验证、黑名单过滤等逻辑。 |
| 会话上下文（Session Context） | 用户在房间中的内部状态记录，包括权限、同步信息、设备标识等。 | 由系统创建与维护。               |
| 实时通信会话                  | WebSocket 或等价协议，用于播放同步和事件广播。               | 在 S2 中建立。                   |
| 同步组（Sync Group）          | 房间内部用于分发统一播放控制指令的逻辑组。                   | 加入后才能同步播放。             |
| 加入房间事件日志              | 系统记录用户加入房间的行为数据。                             | 支撑运维、审计与回溯。           |

---

# 用例 UC-U02：创建观影室（Create Viewing Room）

## 1. 用例名称
创建观影室（Create Viewing Room）  
ID：UC-U02

## 2. 简要描述
本用例描述用户发起创建观影室的请求后，系统如何分配唯一房间 ID、生成房间基础结构、初始化同步状态，并将创建者设置为房间管理员。

系统在后台会执行多项重要操作，包括：生成唯一标识、初始化房间配置、设置默认访问控制策略、建立播放状态对象、注册房间索引、分配系统资源池条目，并记录房间创建事件。这些步骤确保房间在创建后即可被访问、管理与同步。

## 3. 参与者
- **主要参与者：** 用户  
- **次要参与者：** 无

## 4. 前置条件
- 用户必须处于登录且身份有效状态。  
- 系统资源正常可用（包括数据库写入权限、同步模块、ID 池等）。  
- 系统未处于只读模式或房间创建限制中。

## 5. 基本事件流
1. **用例启动：** 用户发起房间创建请求。  
2. 系统解析用户输入的初始化参数（房间名称、访问权限、交互设置等）。  
3. 系统执行 **子流 S3：生成房间基础结构**，包括房间 ID、默认配置、访问策略、同步占位符等。  
4. 系统将用户注册为房间管理员，并为其构建管理员权限集合。  
5. 系统初始化房间同步状态对象（RoomState），其中包含：  
   - 播放进度（0 秒）  
   - 初始播放状态（暂停）  
   - 无视频资源  
   - 默认字幕轨道  
   - 默认倍速  
6. 系统返回创建成功信息，并将用户自动加入房间以继续后续操作（如上传视频、邀请他人等）。  
7. 用例结束。

## 6. 备选流

### A1. 系统无法创建房间
1. 在子流 S3 中，系统发现资源不足（ID 池耗尽、数据库写入异常、房间数达上限等）。  
2. 系统返回“房间创建失败”错误并记录内部失败原因。  
3. 用例失败。

## 7. 子流

### S3. 生成房间基础结构
1. 系统分配唯一房间 ID，并确保其不与现有房间冲突。  
2. 系统在数据库中创建房间记录，包括名称、创建者、创建时间、访问策略等字段。  
3. 系统初始化房间默认配置（默认访问策略、默认人数限制、默认交互功能等）。  
4. 系统创建房间的初始同步状态对象（RoomState）。  
5. 系统将房间注册到房间注册表中，以供查询与访问权限验证使用。  
6. 若上述全部成功，则返回基本流；若任一步失败，则触发备选流 A1。

## 8. 后置条件
- 房间成功注册到系统中，可被正常访问与加入。  
- 房间管理员权限已授予给创建者。  
- 初始同步状态（RoomState）已建立，可被同步模块使用。  
- 系统记录房间创建事件用于审计与分析。

---

# 创建观影室术语表（Glossary - UC-U02）

| 术语                      | 定义                                                   | 备注                  |
| ------------------------- | ------------------------------------------------------ | --------------------- |
| 房间基础结构              | 由系统在 S3 中创建的房间最小数据结构。                 | 包含配置与访问策略。  |
| 房间配置                  | 可由管理员修改的配置项，如名称、访问权限、人数组限等。 | 创建时初始化。        |
| 房间管理员                | 房间创建者，拥有最高管理权限。                         | 系统自动设定。        |
| 管理员权限集合            | 管理员可执行的操作能力集合。                           | 如播放控制、踢人等。  |
| 同步状态对象（RoomState） | 房间的播放同步状态（视频源、进度、字幕等）。           | 在 S3 初始化。        |
| 房间资源池                | 系统为房间分配的资源集合。                             | 若资源不足会触发 A1。 |
| 房间注册表                | 系统的房间索引结构，用于快速检索房间。                 | 在 S3 中注册。        |
| 初始播放状态              | 新房间的默认播放设定：无视频、0 秒、暂停状态。         | 所有房间统一。        |