

## 术语表

| **术语 (Term)**           | **定义 (Definition)**                                        |
| ------------------------- | ------------------------------------------------------------ |
| **Sync_Event (同步事件)** | 系统内部传递的一种控制指令包，用于强制统一房间内的播放状态。包含指令类型（SEEK, PAUSE, PLAY, CHANGE_RATE, CHANGE_SOURCE等）和参数Payload（时间戳/速率/视频源） |
| **CHANGE_RATE (变速)**    | `Sync_Event` 类型。管理员修改了播放速率。Payload 包含新的速率因子（如 1.5, 2.0）。客户端接收后必须调整本地播放器的 播放速率。 |
| **SEEK (跳转)**           | `Sync_Event` 类型。Payload 包含目标时间戳（毫秒）。          |
| **PAUSE / PLAY (启停)**   | `Sync_Event` 类型。指示播放器暂停或开始。                    |
| **CHANGE_SOURCE (换源)**  | `Sync_Event` 类型。管理员更换了播放内容。Payload 包含新的视频 URL、视频标题及初始字幕信息。客户端接收后需重置播放器并加载新资源。 |
|                           |                                                              |
| **同步阈值 **             | 系统允许的最大时间误差值（例如 2000 毫秒）。超过此值的偏差被视为“不同步”，必须触发强制跳转逻辑。 |
| **本地属性 **             | 指音量和 清晰度。这些属性由观众端独立控制，系统严禁将其同步给其他用户。 |
| **房间状态对象 **         | 服务器维护的关于房间当前情况的唯一真实数据集合，用于新用户进房时的初始化同步。（包含：正在播放的视频资源标识、全局基准时间戳、当前播放状态、当前字幕轨道） |
|                           |                                                              |
| **片源转码服务**          | 负责执行耗时的转码任务。本系统依赖该服务完成转码工作，因此被视为**外部参与者**。 |
| **流媒体播放格式**        | 一种特殊的视频传输协议，用于通过网络高效、分段地交付内容。本项目特指 **HLS (HTTP Live Streaming)** |
| **视频库**                | 系统中所有**视频资产记录**的集合。管理员可以从中检索并选择视频进行播放。 |
| **视频资产列表**          | **视频库**的一种视图表现形式。它包含多个**视频资产记录**的摘要，供管理员进行维护操作。 |
| **视频资产记录**          | 系统**持续管理的**关于视频的元数据集合。它包含文件存储位置、处理状态、标题等信息，代表了一个可供流媒体服务使用的资产。 |







## 管理视频库（ID：UC-R04)

### *简要描述*

- 房间管理员将本地视频文件上传至系统。系统接收文件，验证格式(只能是视频格式)与权限，请求外部服务将其转码为流媒体格式，并创建视频资产记录，从而扩充房间的私有片库,解决片源有限的痛点。

### *参与者*

- **发起参与者**：房间管理员

- **其他参与者:**视频转码服务

### *前置条件*

- 房间管理员已登录并拥有当前房间的“资源管理权限”。

- 系统存储空间未满。

### *基本事件流*

*(场景：管理员进入管理模式，浏览列表并上传了一个新视频)*

1. **用例启动**：当房间管理员请求访问房间的视频资源管理功能时，用例启动。
2. **检索资产列表**： 系统检索当前房间内所有**视频资产记录**的集合。系统获取每条记录的摘要信息（包括标题、时长、大小、当前**转码状态**及上传时间）。
3. **呈现列表**： 系统向管理员提供检索到的视频库列表。
4. **发起上传请求**： 管理员向系统提交上传新视频的请求，包含本地文件流及元数据（标题）。
5. **执行子流 S1：验证与接收文件**。 *(注：此处调用子流处理复杂的上传验证逻辑)*
6. **创建资产记录**： 系统在**视频库**中创建一条新的**视频资产记录**，将其状态初始化为“转码中”，并将其关联至当前房间。
7. **请求转码**： 系统向外部参与者**片源转码服务**发送异步处理请求，传递原始文件路径及目标流媒体格式参数（HLS）。
8. **确认任务启动**： 系统接收**片源转码服务**返回的任务确认回执。
9. **更新视图**： 系统向管理员确认操作成功，并刷新视频库列表以显示新添加的记录（状态为处理中）。
10. 用例结束。

### *备选流* 

**A1. 删除视频资产 **

- *触发条件*：在基本流步骤 3 之后，管理员选择删除某个特定的视频。

1. 系统验证该视频是否正在“当前播放”状态。
   - 若正在播放，系统拒绝删除并提示“无法删除正在播放的视频”，流程结束。
2. 系统提示管理员确认删除操作（防止误操作）。
3. 管理员确认删除。
4. 系统执行物理删除操作：移除磁盘上的原始文件及转码后的流媒体切片文件。
5. 系统执行逻辑删除操作：销毁对应的**视频资产记录**。
6. 系统更新剩余存储配额信息。
7. 系统刷新视频库列表，该视频不再可见。
8. 用例结束。

**A2. 查询与过滤**

- *触发条件*：在基本流步骤 3 之后，管理员输入关键词搜索或请求按时间/状态排序。

1. 系统根据管理员提供的过滤条件（如“标题包含X”或“仅显示转码失败项”）重新检索**视频资产记录**。
2. 系统返回过滤后的结果集。
3. 流程返回基本流步骤 3（管理员可基于新列表继续操作）。



**A3.存储空间不足**

1. 在执行子流 S1 期间，系统检测到剩余空间不足以存放新文件。
视频库的一种视图表现形式。它包含多个视频资产记录的摘要，支持排序和过滤，供管理员进行维护操作。
2. 系统拒绝接收数据，并终止上传任务。

3. 系统向管理员报告“存储空间不足”错误。

4. 流程返回基本流步骤 3。

   

**A4. 文件格式不合规**

1. 在**子流S1.验证格式**中，系统检测到文件扩展名不在白名单内，或实际文件头与扩展名不符（伪造格式）。

2. 系统终止处理，不保存任何数据。

3. 系统记录安全警告日志，并向用户返回“不支持的文件格式”错误。

4. 用例结束（失败）。

   

**A5. 完整性校验失败**

1. 在**子流S1.验证与接收文件**步骤步骤 4 中，计算出的校验和与预期不符

2. 系统删除已接收的损坏文件。

3. 系统向用户报告“网络传输错误”并建议重试。

   

### *子流*

**S1.验证与接收文件**

1. **验证权限**：系统验证当前用户是否仍具有上传权限及剩余上传配额。
2. **验证格式**：系统读取文件头，确认文件格式符合视频白名单（如 MP4, MKV），且文件大小未超限。
3. **数据传输**：系统开始接收并写入二进制数据流。
4. **完整性校验**：传输完成后，系统计算并比对文件校验和，确保文件完整。
   - *若任一步骤验证失败，系统抛出异常，触发相应的错误处理备选流。*
5. 返回调用点

### *后置条件*

- **无变更**：若操作取消或失败，视频库状态保持不变。
- **成功添加**：系统物理存储了新文件，并创建了状态为“转码中”的**视频资产记录**。
- **成功删除**：指定的视频文件及相关元数据已从系统中永久移除，存储空间已释放。



---

## 协同观影（UC-R02）

### *简要描述*

- 本用例描述了观众如何在房间内与他人保持同步的观影体验。系统确保所有观众的视频播放进度、播放状态（播放/暂停）、倍速以及字幕选择始终与房间管理员的操作保持一致，从而模拟线下电影院的共时体验。同时，用例允许观众根据自身网络环境独立调整本地视听质量（音量和清晰度），而不干扰房间内的统一播放状态。

### *参与者*

- **房间管理员**：控制视频播放（如播放/暂停、跳转进度）、管理字幕设置，并作为同步信号触发者。

- **观众**：观看视频的同时接收来自服务器的同步指令，但可调整本地视听参数（如音量、清晰度）。

### *前置条件*

- 观众已成功加入观影室。
- 观众客户端与服务器建立了活跃的实时通信连接。

### *基本流*

1. **用例启动**：当观众的浏览器完成播放器组件的加载时，用例启动
2. **初始化房间状态**：系统检索当前房间的`房间状态对象`
3. 系统根据获取的**房间状态对象**初始化本地播放器：
   - 加载指定的视频资源
   - 加载字幕
   - 将进度设定至指定时间
   - 设置播放倍速
4. **执行子流 S1：应用本地偏好设置**
5. **进入同步监听状态**： 系统开始播放（或暂停）视频，并进入持续监听状态，等待接收 **Sync_Event**（同步事件）。
6. **执行子流S2:  处理同步指令**
7. **上报同步状态**: 系统定期生成包含当前本地进度和缓冲状态的**心跳数据**，并将其发送至服务端，以便服务端监控同步误差。
8. **用例结束**： 当观众主动断开连接或离开房间时，用例结束。



### *备选流*

**A1.视频资源失效**

1. 在基本流步骤3中，系统无法加载视频资源。
2. 系统向观众显示错误提示：“视频源不可用”。
3. 系统保持在房间内，但禁用播放器控件。



**A2. 网络延迟过大导致的不同步**

1. 在基本流步骤 8 中，系统计算出 `本地时间戳` 与 `目标时间戳` 的差值超过 **同步阈值 (例如 2秒)** 。
2. 系统强制执行“Seek”操作，跳转至 `目标时间戳`。
3. 系统在界面显示“正在同步...”提示。



### *子流*

 **S1.应用本地偏好设置**

 1.  系统读取观众预设的**本地属性**（音量偏好、清晰度偏好）。
 2.  系统将播放音量设定为预设值。
 3.  系统尝试加载偏好清晰度（如 1080P）的视频流；若该清晰度不可用，则回退至默认清晰度。
 4.  返回调用点。

​	*注：此子流中的操作仅改变本地状态，不触发 Sync_Event 广播* 。

**S2.处理同步指令**

1. 系统解析 **Sync_Event** 的类型和负载数据。
2. **IF** 事件类型为 **PAUSE**：
   - 系统立即停止视频渲染。
3. **IF** 事件类型为 **PLAY**：
   - 系统恢复视频播放。
4. **IF** 事件类型为 **SEEK**：
   - 系统验证目标时间戳有效性。
   - 系统强制将播放进度重置为目标时间戳。
5. **IF** 事件类型为 **CHANGE_RATE**：
   - 系统调整播放速率。
6. **IF** 事件类型为 **CHANGE_SUBTITLE**：
   - 系统加载新的字幕资源。
7. 流程返回调用点（继续监听）。

### *后置条件*

- 系统断开通信连接，并停止上报心跳数据。





