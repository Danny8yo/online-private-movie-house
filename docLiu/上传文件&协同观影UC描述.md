

## 术语表

| **术语 (Term)**           | **定义 (Definition)**                                        |
| ------------------------- | ------------------------------------------------------------ |
| **Sync_Event (同步事件)** | 系统内部传递的一种控制指令包，用于强制统一房间内的播放状态。包含指令类型（SEEK, PAUSE, PLAY, CHANGE_RATE, CHANGE_SOURCE等）和参数Payload（时间戳/速率/视频源） |
| **CHANGE_RATE (变速)**    | `Sync_Event` 类型。管理员修改了播放速率。Payload 包含新的速率因子（如 1.5, 2.0）。客户端接收后必须调整本地播放器的 播放速率。 |
| **SEEK (跳转)**           | `Sync_Event` 类型。Payload 包含目标时间戳（毫秒）。          |
| **PAUSE / PLAY (启停)**   | `Sync_Event` 类型。指示播放器暂停或开始。                    |
| **CHANGE_SOURCE (换源)**  | `Sync_Event` 类型。管理员更换了播放内容。Payload 包含新的视频 URL、视频标题及初始字幕信息。客户端接收后需重置播放器并加载新资源。 |
|                           |                                                              |
| **同步阈值 **             | 系统允许的最大时间误差值（例如 2000 毫秒）。超过此值的偏差被视为“不同步”，必须触发强制跳转逻辑。 |
| **本地属性 **             | 指音量和 清晰度。这些属性由观众端独立控制，系统严禁将其同步给其他用户。 |
| **房间状态对象 **         | 服务器维护的关于房间当前情况的唯一真实数据集合，用于新用户进房时的初始化同步。（包含：正在播放的视频资源标识、全局基准时间戳、当前播放状态、当前字幕轨道） |
|                           |                                                              |
| **片源转码服务**          | 负责执行耗时的转码任务。本系统依赖该服务完成转码工作，因此被视为**外部参与者**。 |
| **流媒体播放格式**        | 一种特殊的视频传输协议，用于通过网络高效、分段地交付内容。本项目特指 **HLS (HTTP Live Streaming)** |
| **视频库**                | 系统中所有**视频资产记录**的集合。管理员可以从中检索并选择视频进行播放。 |
| **视频资产记录**          | 系统**持续管理的**关于视频的元数据集合。它包含文件存储位置、处理状态、标题等信息，代表了一个可供流媒体服务使用的资产。 |







## 上传文件（ID：UC-R04)

### *简要描述*

- 房间管理员将本地视频文件上传至系统。系统接收文件，验证格式(只能是视频格式)与权限，请求外部服务将其转码为流媒体格式，并创建视频资产记录，从而扩充房间的私有片库,解决片源有限的痛点。

### *参与者*

- 房间管理员
- 视频转码服务

### *前置条件*

- 系统存储空间未满。

### *基本事件流*

1. **用例启动**：当房间管理员向系统提交新的视频文件及元数据（如视频标题）的上传请求时，用例启动。
2. **验证上传资格**： 系统根据当前用户的账户策略，验证其上传权限及剩余上传配额。
2. **验证文件合规性**： 系统读取文件头信息，验证文件类型是否属于支持的视频格式白名单（如 MP4, MKV），并确认文件大小未超出系统限制。
3. **数据传输**：系统开始接收完整的视频文件数据。
4. **完整性校验**：文件传输完成后，系统对接收到的文件数据进行完整性校验。系统开始接收并存储视频数据流。
5. **创建资产记录**： 系统在**视频库**中创建一条新的**视频资产记录**。系统记录文件的物理存储路径、基础元数据（标题、上传者ID），并将记录状态初始化为“转码中。
6. **请求转码**： 系统向外部参与者**片源转码服务**发送异步处理请求，传递原始文件路径及目标流媒体格式参数（HLS）。
6. **确认任务启动**： 系统接收**片源转码服务**返回的任务确认回执。
7. **反馈结果**： 系统向房间管理员确认上传成功，并提示转码任务已在后台运行。
7. 用例结束。

### *备选流* 

**A1.存储空间不足**

1. 在基本流步骤2,系统检测到服务器剩余空间不足
2. 系统中断传输任务。
3. 系统向房间管理员报告“存储空间不足”错误。
4. 用例失败。

**A2. 文件格式不合规**

1. 在基本流步骤 3 中，系统检测到文件扩展名不在白名单内，或实际文件头与扩展名不符（伪造格式）。
2. 系统终止处理，不保存任何数据。
3. 系统记录安全警告日志，并向用户返回“不支持的文件格式”错误。
4. 用例结束（失败）。

**A3. 完整性校验失败**

1. 在基本流步骤 5 中，计算出的校验和与预期不符
2. 系统删除已接收的损坏文件。
3. 系统向用户报告“网络传输错误”并建议重试。

**A4.转码失败**

1. 在基本流步骤 9 之后，系统异步接收到**片源转码服务**返回的失败通知。

2. 系统将该**视频资产记录**的状态更新为“转码失败”。

3. 系统向管理员提示转码失败原因，管理员可以选择重新尝试上传或删除记录。用例结束。

### *后置条件*

- 视频文件已存储在系统中。
- 新增一条状态为**“转码中”**的视频资产记录



---

## 协同观影（UC-R02）

### *简要描述*

- 本用例描述了观众如何在房间内与他人保持同步的观影体验。系统确保所有观众的视频播放进度、播放状态（播放/暂停）、倍速以及字幕选择始终与房间管理员的操作保持一致，从而模拟线下电影院的共时体验。同时，用例允许观众根据自身网络环境独立调整本地视听质量（音量和清晰度），而不干扰房间内的统一播放状态。

### *参与者*

- **房间管理员**：控制视频播放（如播放/暂停、跳转进度）、管理字幕设置，并作为同步信号触发者。

- **观众**：观看视频的同时接收来自服务器的同步指令，但可调整本地视听参数（如音量、清晰度）。

### *前置条件*

- 观众已成功加入观影室。
- 观众客户端与服务器建立了活跃的实时通信连接。

### *基本流*

1. **用例启动**：当观众的浏览器完成播放器组件的加载时，用例启动
2. **初始化房间状态**：系统检索当前房间的`房间状态对象`
3. 系统根据获取的**房间状态对象**初始化本地播放器：
   - 加载指定的视频资源
   - 加载字幕
   - 将进度设定至指定时间
   - 设置播放倍速
4. **执行子流 S1：应用本地偏好设置**
5. **进入同步监听状态**： 系统开始播放（或暂停）视频，并进入持续监听状态，等待接收 **Sync_Event**（同步事件）。
6. **执行子流S2:  处理同步指令**
7. **上报同步状态**: 系统定期生成包含当前本地进度和缓冲状态的**心跳数据**，并将其发送至服务端，以便服务端监控同步误差。
8. **用例结束**： 当观众主动断开连接或离开房间时，用例结束。



### *备选流*

**A1.视频资源失效**

1. 在基本流步骤3中，系统无法加载视频资源。
2. 系统向观众显示错误提示：“视频源不可用”。
3. 系统保持在房间内，但禁用播放器控件。



**A2. 网络延迟过大导致的不同步**

1. 在基本流步骤 8 中，系统计算出 `本地时间戳` 与 `目标时间戳` 的差值超过 **同步阈值 (例如 2秒)** 。
2. 系统强制执行“Seek”操作，跳转至 `目标时间戳`。
3. 系统在界面显示“正在同步...”提示。



### *子流*

 **S1.应用本地偏好设置**

 1.  系统读取观众预设的**本地属性**（音量偏好、清晰度偏好）。
 1.  系统将播放音量设定为预设值。
 1.  系统尝试加载偏好清晰度（如 1080P）的视频流；若该清晰度不可用，则回退至默认清晰度。
 1.  返回调用点。

​	*注：此子流中的操作仅改变本地状态，不触发 Sync_Event 广播* 。

**S2.处理同步指令**

1. 系统解析 **Sync_Event** 的类型和负载数据。
2. **IF** 事件类型为 **PAUSE**：
   - 系统立即停止视频渲染。
3. **IF** 事件类型为 **PLAY**：
   - 系统恢复视频播放。
4. **IF** 事件类型为 **SEEK**：
   - 系统验证目标时间戳有效性。
   - 系统强制将播放进度重置为目标时间戳。
5. **IF** 事件类型为 **CHANGE_RATE**：
   - 系统调整播放速率。
6. **IF** 事件类型为 **CHANGE_SUBTITLE**：
   - 系统加载新的字幕资源。
7. 流程返回调用点（继续监听）。

### *后置条件*

- 系统断开通信连接，并停止上报心跳数据。





