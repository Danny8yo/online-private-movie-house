## 术语表

| **术语 (Term)**                | **定义 (Definition)**                                        |
| ------------------------------ | ------------------------------------------------------------ |
| **Sync_Event (同步事件)**      | 系统内部传递的一种控制指令包，用于强制统一房间内的播放状态。包含指令类型（SEEK, PAUSE, PLAY, CHANGE_RATE, CHANGE_SOURCE等）和参数Payload（时间戳/速率/视频源） |
| **CHANGE_RATE (变速)**         | `Sync_Event` 类型。管理员修改了播放速率。Payload 包含新的速率因子（如 1.5, 2.0）。客户端接收后必须调整本地播放器的 播放速率。 |
| **SEEK (跳转)**                | `Sync_Event` 类型。Payload 包含目标时间戳（毫秒）。          |
| **PAUSE / PLAY (启停)**        | `Sync_Event` 类型。指示播放器暂停或开始。                    |
| **CHANGE_SUBTITLE (更改字幕)** | `Sync_Event` 类型。管理员更换了播放内容。Payload 包含新字幕信息。客户端接收后需更改当前播放视频的字幕轨道。 |
| **房间状态对象**               | 服务器维护的关于房间当前情况的唯一真实数据集合，用于新用户进房时的初始化同步。（包含：正在播放的视频资源标识、全局基准时间戳、当前播放状态、当前字幕轨道、当前播放倍数） |
| **审计日志**                   | 系统为每一次控制操作记录的不可篡改的日志，通常包含操作者、操作类型、操作时间、操作参数等信息，用于安全审计和问题追踪 。 |
| **同步阈值**                   | 系统允许的最大时间误差值（例如 2000 毫秒）。超过此值的偏差被视为"不同步"，必须触发强制跳转逻辑。 |
| **本地属性**                   | 指音量和清晰度。这些属性由观众端独立控制，系统严禁将其同步给其他用户。 |
| **操作时间戳**                 | 记录控制操作发生时刻的唯一时间标识。用于解决操作冲突、保证操作顺序以及进行日志记录 。 |
| **状态恢复机制**               | 当用户因网络问题暂时断开连接并重连后，系统能够自动将其播放器状态（进度、播放/暂停等）恢复到与当前房间状态对象一致的流程。 |


# 用例描述：主持放映

## 1. 用例名称 
主持放映

## 2. 用例ID
UC-04

## 3. 简要描述 
本用例描述了房间管理员如何全面控制放映室的观影体验。管理员可以管理当前播放的内容（更换视频源）以及控制播放状态（播放、暂停、进度跳转、倍速、字幕）。所有控制操作将实时同步给房间内的所有观众，以确保"同频"观影体验。

## 4. 参与者
**房间管理员**：拥有控制放映权限的用户（包括房主或被提拔的管理员）。

## 5. 前置条件 
1. 观影房间已存在。
2. 管理员已成功进入房间并与系统建立连接。
3. 视频播放器成功加载并准备好播放一个有效的视频源。

## 6. 基本事件流 

### {启动控制}
1. **管理员**请求执行播放控制操作（默认为"切换播放/暂停"状态）。

### {验证与执行}
2. 执行子流 **S1: 验证与处理请求**。

### {同步状态}
3. **系统**更新**房间状态对象**（播放状态变更）。
4. **系统**生成类型为 `PLAY` 或 `PAUSE` 的 **Sync_Event**。
5. 执行子流 **S2: 广播与审计**。

### {用例结束}
6. 用例暂告一段落，等待下一次控制指令。

---

## 7. 备选流 

### A1: 更换视频源 
* **触发条件**: 在基本流步骤 1，管理员请求更换当前播放的视频内容。
* **处理流程**:
    1. **系统**提示管理员选择视频来源方式（内部视频库 或 外部链接）。
    2. **管理员**执行选择：
        * *分支 A1.1 (内部库)*: 管理员浏览系统视频库并选择一个视频。
        * *分支 A1.2 (外部链)*: 管理员输入外部视频的 URL。
    3. **系统**检查视频资源的可用性。
    4. **系统**请求管理员确认更换操作（防止误触）。
    5. **管理员**确认操作。
    6. **系统**重置**房间状态对象**（将进度归零，状态置为暂停，更新资源标识）。
    7. **系统**生成类型为 `CHANGE_SOURCE` 的 **Sync_Event**。
    8. 事件流转至基本流步骤 5（广播与审计）。

### A2: 跳转进度 
* **触发条件**: 在基本流步骤 1，管理员拖动进度条或指定播放时间点。
* **处理流程**:
    1. 执行子流 **S1: 验证与处理请求**。
    2. **系统**验证目标时间戳的有效性（在视频时长范围内）。
    3. **系统**更新**房间状态对象**中的基准时间戳。
    4. **系统**生成类型为 `SEEK` 的 **Sync_Event**（Payload包含目标时间戳）。
    5. 事件流转至基本流步骤 5。

### A3: 更改播放倍速 
* **触发条件**: 在基本流步骤 1，管理员选择新的播放倍速（如 1.5x）。
* **处理流程**:
    1. 执行子流 **S1: 验证与处理请求**。
    2. **系统**验证倍速率值的有效性（如 0.5, 1.0, 1.5, 2.0等）。
    3. **系统**更新**房间状态对象**的播放倍速。
    4. **系统**生成类型为 `CHANGE_RATE` 的 **Sync_Event**。
    5. 事件流转至基本流步骤 5。

### A4: 更换字幕 
* **触发条件**: 在基本流步骤 1，管理员选择不同的字幕轨道。
* **处理流程**:
    1. 执行子流 **S1: 验证与处理请求**。
    2. **系统**验证字幕轨道标识的有效性。
    3. **系统**更新**房间状态对象**的当前字幕轨道。
    4. **系统**生成类型为 `CHANGE_SUBTITLE` 的 **Sync_Event**。
    5. 事件流转至基本流步骤 5。

### A5: 验证失败或资源不可用
* **触发条件**: 在子流 S1 中验证失败，或在 A1 中视频资源无效。
* **处理流程**:
    1. **系统**向管理员显示具体的错误提示（如"无操作权限"或"视频链接无效"）。
    2. **系统**保持当前播放状态不变。
    3. 用例终止。

### A6: 取消操作 
* **触发条件**: 在 A1 步骤 4 中，管理员选择"取消"。
* **处理流程**:
    1. **系统**关闭选择窗口。
    2. 用例终止，状态回滚。

### A7: 房间状态对象异常
* **触发条件**: 在基本流步骤 3 中，系统发现房间状态对象损坏、丢失或处于无法更新的非法状态。
* **处理流程**:
    1. **系统**终止当前操作，并向管理员发送"系统状态异常，请稍后重试"的错误信息。
    2. **系统**尝试根据最新的审计日志重建房间状态对象。
    3. 用例终止。

### A8: 同步过程失败
* **触发条件**: 在子流 S2 中，如果部分用户同步失败。
* **处理流程**:
    1. **系统**记录同步异常日志。
    2. 对于同步失败的观众，系统在其重新连接时提供状态恢复机制：
        - 如果重新连接成功，用例恢复到基本流。
        - 如果重新连接失败，则提示相应的错误信息，用例终止。

### A9: 时间偏差超过同步阈值
* **触发条件**: 在子流 S2 中，如果在同步后检测到其他用户其本地播放时间戳与 Sync_Event 中的时间戳偏差超过同步阈值。
* **处理流程**:
    1. 该用户的播放器将立即执行强制跳转，将进度修正到 Sync_Event 指定的时间戳。
    2. 系统可记录此事件到审计日志用于服务质量监控。
    3. 用例恢复到基本流。

---

## 8. 子流

### S1: 验证与处理请求
1. **系统**验证当前用户是否具有**管理员**身份。
2. **系统**验证管理员与服务器的连接状态是否正常。
3. **系统**验证请求的操作参数是否合法（例如：跳转时间是否在视频时长范围内）。

### S2: 广播与审计
1. **系统**将生成的 **Sync_Event** 广播给房间内所有连接的观众客户端。
    * *注：观众客户端接收后将根据指令强制同步本地播放器状态。*
2. **系统**生成一条**审计日志**（包含操作者ID、操作类型、时间戳、操作参数）。
3. **系统**将日志持久化存储。

---

## 9. 后置条件 
1. **房间状态对象**已根据管理员的操作完成更新，成为新的"唯一真实数据源"。
2. 房间内所有观众的播放器状态已通过 **Sync_Event** 开始同步过程。
3. 系统审计日志中新增了一条操作记录。
4. 所有同步成功的观众，其本地播放状态与房间状态对象一致。

## 10. 特殊需求与业务规则
1. **强制同步规则**：如果观众端的本地播放时间与 **Sync_Event** 指定时间的偏差超过**同步阈值**（如 2000ms），系统必须强制校准观众端进度，而非平滑过渡。
2. **本地属性隔离**：管理员的操作**严禁**影响观众的"本地属性"（音量大小、画面清晰度、本地弹幕开关）。
3. **状态恢复**：若管理员在操作过程中断线，系统应保持最后一次确认的房间状态，直到管理员重连或新管理员接管。
4. **操作顺序保证**：所有控制操作必须按照操作时间戳的顺序执行，避免操作冲突。
5. **审计完整性**：所有控制操作必须记录完整的审计日志，用于安全审计和问题追踪。