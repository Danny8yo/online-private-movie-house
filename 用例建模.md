# 3. 用例建模

## 3.1 识别参与者

根据《用例建模》教材，参与者定义了用户在与系统交互过程中所扮演的角色，且必须位于系统边界之外。

### 1. 用户 (User)

* **描述**：任何访问线上观影厅平台，尚未进入特定放映室或未确立特定房间身份的人。
* **成为参与者的理由**：
  * **角色起点**：在“观影大厅”场景下，用户仅需执行“创建”或“加入”操作，此时尚未分化为具体的房间角色（如房主或管理员）。
  * **系统外部性**：代表了尚未进入系统核心业务（观影）边界的外部操作者。

### 2. 房主 (Host)

* **描述**：房间的创建者或所有者，拥有最高管理权限，负责房间的生命周期管理和人员任命。
* **成为参与者的理由**：
  * **独特的权责**：房主的核心职责是“所有权”体现，如“提拔某人为管理员”和“解散房间”。这些操作涉及权限的分配和房间的存亡，与具体的观影操作（如播放/暂停）不同，属于更高层级的管理角色。
  * **区别于运作**：房主即使不亲自控制播放，也依然拥有解散房间的权力，这证明了该角色的独立性。

### 3. 管理员 (Administrator)

* **描述**：负责维持房间内观影秩序和放映节奏的用户（房主在进行这些操作时，也是在扮演此角色）。
* **成为参与者的理由**：
  * **业务运作核心**：管理员直接负责“控制放映节奏”（如主持放映）和“维护秩序”（如管理成员）。这是系统为了维持“协同观影”正常进行所必需的职能角色。
  * **角色复用 (Hat Theory)**：定义此参与者符合教材中“参与者代表角色”的原则。无论是被提拔的普通管理员，还是亲自操作的房主，当他们执行“控制放映”时，都是在扮演这个“管理员”角色。

### 4. 观众 (Audience)

* **描述**：加入放映室进行观影和互动，但不具备控制播放进度权限的用户。
* **成为参与者的理由**：
  * **被动接收者**：观众的主要特征是“跟随”。他们接收系统同步的画面流，是“协同观影”用例的主要服务对象。
  * **互动需求**：观众通过“参与互动”来满足社交需求，这是区别于单机播放器的关键角色特征。



### 5. 视频转码服务 (Video Transcoding Service)

* **描述**：负责将用户上传的原始视频文件转换为适合网络流媒体播放格式（如 HLS/m3u8）的外部系统或独立服务组件。
* **成为参与者的理由**：
  * **系统参与者**：根据教材，参与者不仅限于人，也可以是与所构建系统交互的其他系统 。
  * **边界定义**：该服务独立于核心业务逻辑（观影/互动）。通过将其定义为参与者，明确了“线上观影厅”系统只负责**发送**转码请求和**接收**转码结果，而不需要关心转码的具体实现细节，这有助于界定系统边界 。
  * **异步交互**：转码通常是一个耗时费力的操作。将其视为独立参与者，能清晰地描述系统在上传视频后等待其回调或轮询其状态的交互过程。

---

## 3.2 识别用例

根据教材，用例描述了系统与参与者如何协作以实现参与者的目标，且必须为参与者提供可观测的价值。

### UC-01: 创建观影室 (Create Screening Room)

* **涉及参与者**：用户
* **描述**：用户填写房间名称、设置密码，建立一个新的观影空间并自动成为房主。
* **成为用例的理由**：
  * **身份转换**：此用例不仅创建了系统对象（房间），还完成了参与者角色的转换（从普通用户变为房主），是房主所有后续操作的前置条件。
  * **价值起点**：为用户提供了“拥有一个私密空间”的初始价值。

### UC-02: 加入观影室 (Join Screening Room)

* **涉及参与者**：用户
* **描述**：用户通过房间列表或房间码，输入密码（如有），进入特定的观影房间。
* **成为用例的理由**：
  * **独立的业务目标**：用户的目标是“进入空间”。这与“创建房间”是完全分离的时间和意图。
    * **包含完整流程**：它封装了查找房间、验证密码、建立连接等一系列步骤，是一个完整的事件流。

### UC-03: 配置房间 (Configure Room)

* **涉及参与者**：房主
* **描述**：修改房间信息（如标题、密码）、提拔某人为管理员、撤销管理员权限或解散房间。
* **成为用例的理由**：
  * **权限隔离**：这些操作涉及房间的“所有权”和“授权”，只有房主有权执行。将此作为独立用例，清晰地界定了房主与管理员的边界。
  * **生命周期管理**：包含了房间从修改属性到终结的完整管理过程。

### UC-04: 主持放映 (Control Screening)

* **涉及参与者**：管理员
* **描述**：控制当前播放的内容和节奏，包括选择视频源、暂停/播放、跳转进度、调整倍速和更换字幕。
* **成为用例的理由**：
  * **职责归位**：控制放映节奏是管理员的职责。这确保了用例与角色的映射准确反映了业务逻辑。
  * **合成价值**：将“更换视频源”、“跳转进度”等操作合并在此用例中，避免了功能分解，完整描述了“主持一场放映”这一有价值的任务。

### UC-05: 管理视频库 (Manage Video Library)

* **涉及参与者**：管理员、视频转码服务
* **描述**：上传新的视频文件、更新现有视频信息或删除视频。
* **成为用例的理由**：
  * **支持性任务**：为了实现放映，必须先有内容。管理员负责维护这个资源库，这是一个独立的支持性工作流，响应了愿景中“片源自由”的需求。

### UC-06: 管理成员 (Manage Members)

* **涉及参与者**：管理员
* **描述**：对房间内的成员进行管理，包括踢出用户、禁言特定用户或开启全局禁言。
* **成为用例的理由**：
  * **维护环境**：为了保证观影体验不被破坏，管理员需要执行此用例来维护秩序。这是一个明确的管理性目标。

### UC-07: 协同观影 (Collaborative Viewing)

* **涉及参与者**：观众
* **描述**：观众进入房间后，画面与放映进度保持同步，系统自动处理播放状态的同步。
* **成为用例的理由**：
  * **核心价值交付**：这是愿景文档中“实时播放同步”这一核心解决方案的直接体现。
  * **被动目标的实现**：虽然观众操作较少，但系统必须执行复杂的同步逻辑来实现观众“和朋友一起看”的目标。

### UC-08: 参与互动 (Participate in Interaction)

* **涉及参与者**：观众
* **描述**：用户在观影过程中发送文字消息或弹幕进行交流。
* **成为用例的理由**：
  * **满足社交需求**：愿景文档强调了“营造陪伴感”是关键需求。
  * **完整的目标**：将发送消息和弹幕合并，兼并体现了系统作为社交工具的价值。





---

# UC-01创建观影室

## 术语表

| **术语 (Term)**           | **定义 (Definition)**                                        |
| ------------------------- | ------------------------------------------------------------ |
| **Sync_Event (同步事件)** | 系统内部传递的一种控制指令包，用于强制统一房间内的播放状态。包含指令类型（SEEK, PAUSE, PLAY, CHANGE_RATE, CHANGE_SOURCE等）和参数Payload（时间戳/速率/视频源） |
| **CHANGE_RATE (变速)**    | `Sync_Event` 类型。管理员修改了播放速率。Payload 包含新的速率因子（如 1.5, 2.0）。客户端接收后必须调整本地播放器的 播放速率。 |
| **SEEK (跳转)**           | `Sync_Event` 类型。Payload 包含目标时间戳（毫秒）。          |
| **PAUSE / PLAY (启停)**   | `Sync_Event` 类型。指示播放器暂停或开始。                    |
| **CHANGE_SOURCE (换源)**  | `Sync_Event` 类型。管理员更换了播放内容。Payload 包含新的视频 URL、视频标题及初始字幕信息。客户端接收后需重置播放器并加载新资源。 |
|                           |                                                              |
| **同步阈值 **             | 系统允许的最大时间误差值（例如 2000 毫秒）。超过此值的偏差被视为“不同步”，必须触发强制跳转逻辑。 |
| **本地属性 **             | 指音量和 清晰度。这些属性由观众端独立控制，系统严禁将其同步给其他用户。 |
| **房间状态对象 **         | 服务器维护的关于房间当前情况的唯一真实数据集合，用于新用户进房时的初始化同步。（包含：正在播放的视频资源标识、全局基准时间戳、当前播放状态、当前字幕轨道） |
|                           |                                                              |
| **片源转码服务**          | 负责执行耗时的转码任务。本系统依赖该服务完成转码工作，因此被视为**外部参与者**。 |
| **流媒体播放格式**        | 一种特殊的视频传输协议，用于通过网络高效、分段地交付内容。本项目特指 **HLS (HTTP Live Streaming)** |
| **视频库**                | 系统中所有**视频资产记录**的集合。管理员可以从中检索并选择视频进行播放。 |
| **视频资产列表**          | **视频库**的一种视图表现形式。它包含多个**视频资产记录**的摘要，供管理员进行维护操作。 |
| **视频资产记录**          | 系统**持续管理的**关于视频的元数据集合。它包含文件存储位置、处理状态、标题等信息，代表了一个可供流媒体服务使用的资产。 |

## 用例名称
**创建观影室**

## 简要描述
本用例描述了用户如何请求系统生成一个新的观影室。系统在验证请求有效后，实例化一个新的房间对象，并将发起用户指定为该房间的**房主**。

## 参与者
- **发起参与者**：用户 (User)

## 前置条件
- 用户已登录系统。
- 用户未达到创建房间的数量上限（若有）。

## 基本事件流
1. **用例启动**：用户向系统提交创建新观影室的请求，并提供初始配置参数（如房间名称、是否公开）。
2. **验证请求**：系统确认用户的请求参数格式正确，且符合业务规则（如房间名未包含敏感词）。
3. **生成房间**：系统在数据库中创建一个新的观影室实例，生成唯一的房间标识符，并初始化房间状态。
4. **分配权限**：系统将当前用户记录为该新房间的**房主**。
5. **初始化状态**：系统将房间标记为“可加入状态”。
6. **反馈结果**：系统向用户返回创建成功的确认信息及新房间的访问入口。
7. **用例结束**。

## 备选事件流 

### A1. 创建受限
* **触发条件**：在基本流步骤 2，系统检测到用户已达到最大持有的房间数量限制。
1. 系统拒绝创建请求。
2. 系统向用户显示“创建数量已达上限”的提示。
3. 用例结束。

### A2. 系统资源不足
* **触发条件**：在基本流步骤 3，系统因负载过高或存储不足无法分配新房间。
1. 系统记录错误日志。
2. 系统向用户提示“服务暂时不可用，请稍后重试”。
3. 用例结束。

## 后置条件
- **成功**：系统中新增了一个关联到该用户的观影室记录；用户拥有该房间的最高权限。
- **失败**：系统状态无变化。

---
---

# UC-02加入观影室

## 简要描述
本用例描述了用户如何尝试进入一个已存在的观影室。系统验证房间状态及用户的加入资格（如密码），并在验证通过后，将用户的播放状态与房间内其他成员进行**初始同步**。

## 参与者
- **发起参与者**：用户 

## 前置条件
- 用户已登录。
- 用户已知晓目标房间的标识符（ID或房间号）。

## 基本事件流 
1. **用例启动**：用户向系统发起加入指定观影室的请求。
2. **验证房间状态**：
   - 系统检索目标房间信息。
   - **执行子流 S1：验证加入条件**。
3. **执行加入**：系统将用户添加到该房间的“在线成员列表”中。
4. **初始同步**：
   - 系统获取房间当前的播放状态（视频源、进度、倍速）。
   - 系统将该状态发送给用户客户端，强制用户端播放器与房间保持一致。
5. **广播通知**：系统向房间内现有的其他成员广播“新用户加入”的系统消息。
6. **用例结束**。

## 备选事件流 

### A1. 房间不存在
* **触发条件**：在基本流步骤 2，系统无法找到指定 ID 的房间。
1. 系统向用户提示“房间不存在”。
2. 用例结束。

### A2. 房间不可加入
* **触发条件**：在子流 S1 中，房间已满员或被锁定。
1. 系统拒绝加入请求。
2. 系统向用户显示具体原因（如“房间人数已满”）。
3. 用例结束。

### A3. 凭据验证失败
* **触发条件**：在子流 S1 中，用户提供的**加入凭据**（密码）错误。
1. 系统提示“密码错误”。
2. 系统允许用户重新输入凭据（返回子流 S1）。

## 子流

### S1. 验证加入条件
1. 系统检查房间是否处于“可加入状态”（未解散、未被系统封禁）。
2. 系统检查房间当前人数是否已达上限。
3. **IF** 房间设置了访问密码（私密房间）：
   - 系统验证用户提供的**加入凭据**是否与房间设置匹配。
4. **结果**：若任一检查失败，触发相应的备选流（A2 或 A3）；若全部通过，返回基本流。

## 后置条件
- **成功**：用户与房间建立了活跃连接；用户的播放状态与房间同步。
- **失败**：用户未能进入房间，且未获取房间内的任何信息。

---
---

# UC-03配置房间

## 简要描述
本用例描述了**房主**如何通过系统对房间的属性（如人数限制、访问密码）、成员权限进行调整，或执行解散房间等高危操作。该用例确保了房主对房间资产和秩序拥有最高控制权。

## 参与者
- **发起参与者**：房主

## 前置条件
- 房主已登录系统。
- 目标房间处于活跃状态。

## 基本事件流 
*(场景：房主修改房间的最大人数限制和公开状态)*

1. **用例启动**：房主请求对房间进行配置管理，用例启动。
2. **展示信息**：系统检索并显示当前房间的配置信息（包括最大人数、公开状态、管理员列表）。
3. **选择操作**：房主选择修改房间的基本信息。
4. **输入参数**：房主提供新的最大人数数值或修改公开性设置。
5. **业务规则校验**：
   - 系统验证输入人数是否在允许范围内（如 2-50 人）。
   - 系统验证新人数是否低于当前在线人数（若低于则不允许修改）。
6. **保存配置**：系统更新房间的元数据信息。
7. **反馈结果**：系统向房主确认配置已更新，并向房间内所有成员广播配置变更通知（如“房间人数上限已调整”）。
8. **用例结束**。

## 备选事件流 

### A1. 管理员权限变更 
* **触发条件**：在基本流步骤 3，房主选择“管理管理员”。
1. 系统显示当前的成员列表及身份标识。
2. 房主选择一名成员并指定操作（提拔为管理员 / 取消管理员）。
3. 系统验证操作合法性（例如：不能取消自己的房主身份）。
4. 系统更新该成员在数据库中的权限状态。
5. 系统向相关成员发送权限变更通知。
6. 流程返回基本流步骤 2（房主可继续进行其他配置）。

### A2. 解散房间
* **触发条件**：在基本流步骤 3，房主选择“解散房间”。
1. 系统显示解散后果警告（“操作不可恢复，所有数据将被清除”）。
2. 房主确认解散操作。
3. 系统强制断开房间内所有用户的连接。
4. 系统从数据库中物理删除房间记录及关联数据。
5. 用例结束。

### A3. 设置密码保护 
* **触发条件**：在基本流步骤 4，房主将房间设置为“私密/不公开”。
1. 系统要求房主设置入场密码。
2. 房主输入密码。
3. 系统验证密码复杂度（如：需4-6位数字）。
   - *若验证失败，系统提示错误，重复步骤 2。*
4. 系统保存加密后的密码。
5. 流程合并至基本流步骤 6。

### A4. 校验失败
* **触发条件**：在基本流步骤 5，数据不符合业务规则。
1. 系统显示具体的错误原因（如“人数不能小于当前在线人数”）。
2. 流程返回基本流步骤 4，允许房主重新输入。

## 后置条件
- **修改成功**：房间配置或成员权限已更新至服务器。
- **解散成功**：房间对象及相关会话被销毁。
- **操作取消/失败**：房间状态保持操作前原样。

---

# UC-04主持放映

| 术语                           | 定义                                                         |
| ------------------------------ | ------------------------------------------------------------ |
| **Sync_Event (同步事件)**      | 系统内部传递的一种控制指令包，用于强制统一房间内的播放状态。包含指令类型（SEEK, PAUSE, PLAY, CHANGE_RATE, CHANGE_SOURCE等）和参数Payload（时间戳/速率/视频源） |
| **CHANGE_RATE (变速)**         | `Sync_Event` 类型。管理员修改了播放速率。Payload 包含新的速率因子（如 1.5, 2.0）。客户端接收后必须调整本地播放器的 播放速率。 |
| **SEEK (跳转)**                | `Sync_Event` 类型。Payload 包含目标时间戳（毫秒）。          |
| **PAUSE / PLAY (启停)**        | `Sync_Event` 类型。指示播放器暂停或开始。                    |
| **CHANGE_SUBTITLE (更改字幕)** | `Sync_Event` 类型。管理员更换了播放内容。Payload 包含新字幕信息。客户端接收后需更改当前播放视频的字幕轨道。 |
| **房间状态对象**               | 服务器维护的关于房间当前情况的唯一真实数据集合，用于新用户进房时的初始化同步。（包含：正在播放的视频资源标识、全局基准时间戳、当前播放状态、当前字幕轨道、当前播放倍数） |
| **审计日志**                   | 系统为每一次控制操作记录的不可篡改的日志，通常包含操作者、操作类型、操作时间、操作参数等信息，用于安全审计和问题追踪 。 |
| **同步阈值**                   | 系统允许的最大时间误差值（例如 2000 毫秒）。超过此值的偏差被视为"不同步"，必须触发强制跳转逻辑。 |
| **本地属性**                   | 指音量和清晰度。这些属性由观众端独立控制，系统严禁将其同步给其他用户。 |
| **操作时间戳**                 | 记录控制操作发生时刻的唯一时间标识。用于解决操作冲突、保证操作顺序以及进行日志记录 。 |
| **状态恢复机制**               | 当用户因网络问题暂时断开连接并重连后，系统能够自动将其播放器状态（进度、播放/暂停等）恢复到与当前房间状态对象一致的流程。 |

## 简要描述 
本用例描述了房间管理员如何全面控制放映室的观影体验。管理员可以管理当前播放的内容（更换视频源）以及控制播放状态（播放、暂停、进度跳转、倍速、字幕）。所有控制操作将实时同步给房间内的所有观众，以确保"同频"观影体验。

## 参与者
**房间管理员**：拥有控制放映权限的用户（包括房主或被提拔的管理员）。

## 前置条件 
1. 观影房间已存在。
2. 管理员已成功进入房间并与系统建立连接。
3. 视频播放器成功加载并准备好播放一个有效的视频源。

## 基本事件流 

### {启动控制}
1. **管理员**请求执行播放控制操作（默认为"切换播放/暂停"状态）。

### {验证与执行}
2. 执行子流 **S1: 验证与处理请求**。

### {同步状态}
3. **系统**更新**房间状态对象**（播放状态变更）。
4. **系统**生成类型为 `PLAY` 或 `PAUSE` 的 **Sync_Event**。
5. 执行子流 **S2: 广播与审计**。

### {用例结束}
6. 用例暂告一段落，等待下一次控制指令。

---

## 备选流 

### A1: 更换视频源 
* **触发条件**: 在基本流步骤 1，管理员请求更换当前播放的视频内容。
* **处理流程**:
    1. **系统**提示管理员选择视频来源方式（内部视频库 或 外部链接）。
    2. **管理员**执行选择：
        * *分支 A1.1 (内部库)*: 管理员浏览系统视频库并选择一个视频。
        * *分支 A1.2 (外部链)*: 管理员输入外部视频的 URL。
    3. **系统**检查视频资源的可用性。
    4. **系统**请求管理员确认更换操作（防止误触）。
    5. **管理员**确认操作。
    6. **系统**重置**房间状态对象**（将进度归零，状态置为暂停，更新资源标识）。
    7. **系统**生成类型为 `CHANGE_SOURCE` 的 **Sync_Event**。
    8. 事件流转至基本流步骤 5（广播与审计）。

### A2: 跳转进度 
* **触发条件**: 在基本流步骤 1，管理员拖动进度条或指定播放时间点。
* **处理流程**:
    1. 执行子流 **S1: 验证与处理请求**。
    2. **系统**验证目标时间戳的有效性（在视频时长范围内）。
    3. **系统**更新**房间状态对象**中的基准时间戳。
    4. **系统**生成类型为 `SEEK` 的 **Sync_Event**（Payload包含目标时间戳）。
    5. 事件流转至基本流步骤 5。

### A3: 更改播放倍速 
* **触发条件**: 在基本流步骤 1，管理员选择新的播放倍速（如 1.5x）。
* **处理流程**:
    1. 执行子流 **S1: 验证与处理请求**。
    2. **系统**验证倍速率值的有效性（如 0.5, 1.0, 1.5, 2.0等）。
    3. **系统**更新**房间状态对象**的播放倍速。
    4. **系统**生成类型为 `CHANGE_RATE` 的 **Sync_Event**。
    5. 事件流转至基本流步骤 5。

### A4: 更换字幕 
* **触发条件**: 在基本流步骤 1，管理员选择不同的字幕轨道。
* **处理流程**:
    1. 执行子流 **S1: 验证与处理请求**。
    2. **系统**验证字幕轨道标识的有效性。
    3. **系统**更新**房间状态对象**的当前字幕轨道。
    4. **系统**生成类型为 `CHANGE_SUBTITLE` 的 **Sync_Event**。
    5. 事件流转至基本流步骤 5。

### A5: 验证失败或资源不可用
* **触发条件**: 在子流 S1 中验证失败，或在 A1 中视频资源无效。
* **处理流程**:
    1. **系统**向管理员显示具体的错误提示（如"无操作权限"或"视频链接无效"）。
    2. **系统**保持当前播放状态不变。
    3. 用例终止。

### A6: 取消操作 
* **触发条件**: 在 A1 步骤 4 中，管理员选择"取消"。
* **处理流程**:
    1. **系统**关闭选择窗口。
    2. 用例终止，状态回滚。

### A7: 房间状态对象异常
* **触发条件**: 在基本流步骤 3 中，系统发现房间状态对象损坏、丢失或处于无法更新的非法状态。
* **处理流程**:
    1. **系统**终止当前操作，并向管理员发送"系统状态异常，请稍后重试"的错误信息。
    2. **系统**尝试根据最新的审计日志重建房间状态对象。
    3. 用例终止。

### A8: 同步过程失败
* **触发条件**: 在子流 S2 中，如果部分用户同步失败。
* **处理流程**:
    1. **系统**记录同步异常日志。
    2. 对于同步失败的观众，系统在其重新连接时提供状态恢复机制：
        - 如果重新连接成功，用例恢复到基本流。
        - 如果重新连接失败，则提示相应的错误信息，用例终止。

### A9: 时间偏差超过同步阈值
* **触发条件**: 在子流 S2 中，如果在同步后检测到其他用户其本地播放时间戳与 Sync_Event 中的时间戳偏差超过同步阈值。
* **处理流程**:
    1. 该用户的播放器将立即执行强制跳转，将进度修正到 Sync_Event 指定的时间戳。
    2. 系统可记录此事件到审计日志用于服务质量监控。
    3. 用例恢复到基本流。

---

## 子流

### S1: 验证与处理请求
1. **系统**验证当前用户是否具有**管理员**身份。
2. **系统**验证管理员与服务器的连接状态是否正常。
3. **系统**验证请求的操作参数是否合法（例如：跳转时间是否在视频时长范围内）。

### S2: 广播与审计
1. **系统**将生成的 **Sync_Event** 广播给房间内所有连接的观众客户端。
    * *注：观众客户端接收后将根据指令强制同步本地播放器状态。*
2. **系统**生成一条**审计日志**（包含操作者ID、操作类型、时间戳、操作参数）。
3. **系统**将日志持久化存储。

---

## 后置条件 
1. **房间状态对象**已根据管理员的操作完成更新，成为新的"唯一真实数据源"。
2. 房间内所有观众的播放器状态已通过 **Sync_Event** 开始同步过程。
3. 系统审计日志中新增了一条操作记录。
4. 所有同步成功的观众，其本地播放状态与房间状态对象一致。

## 特殊需求与业务规则
1. **强制同步规则**：如果观众端的本地播放时间与 **Sync_Event** 指定时间的偏差超过**同步阈值**（如 2000ms），系统必须强制校准观众端进度，而非平滑过渡。
2. **本地属性隔离**：管理员的操作**严禁**影响观众的"本地属性"（音量大小、画面清晰度、本地弹幕开关）。
3. **状态恢复**：若管理员在操作过程中断线，系统应保持最后一次确认的房间状态，直到管理员重连或新管理员接管。
4. **操作顺序保证**：所有控制操作必须按照操作时间戳的顺序执行，避免操作冲突。
5. **审计完整性**：所有控制操作必须记录完整的审计日志，用于安全审计和问题追踪。



---

## UC-05管理视频库

### 术语表

| **术语 (Term)**    | **定义 (Definition)**                                        |
| ------------------ | ------------------------------------------------------------ |
| **片源转码服务**   | 负责执行耗时的转码任务。本系统依赖该服务完成转码工作，因此被视为**外部参与者**。 |
| **流媒体播放格式** | 一种特殊的视频传输协议，用于通过网络高效、分段地交付内容。本项目特指 **HLS (HTTP Live Streaming)** |
| **视频库**         | 系统中所有**视频资产记录**的集合。管理员可以从中检索并选择视频进行播放。 |
| **视频资产列表**   | **视频库**的一种视图表现形式。它包含多个**视频资产记录**的摘要，供管理员进行维护操作。 |
| **视频资产记录**   | 系统**持续管理的**关于视频的元数据集合。它包含文件存储位置、处理状态、标题等信息，代表了一个可供流媒体服务使用的资产。 |

### *简要描述*

- 房间管理员将本地视频文件上传至系统。系统接收文件，验证格式(只能是视频格式)与权限，请求外部服务将其转码为流媒体格式，并创建视频资产记录，从而扩充房间的私有片库,解决片源有限的痛点。

### *参与者*

- **发起参与者**：房间管理员

- **其他参与者:**视频转码服务

### *前置条件*

- 房间管理员已登录并拥有当前房间的“资源管理权限”。

- 系统存储空间未满。

### *基本事件流*

*(场景：管理员进入管理模式，浏览列表并上传了一个新视频)*

1. **用例启动**：当房间管理员请求访问房间的视频资源管理功能时，用例启动。
2. **检索资产列表**： 系统检索当前房间内所有**视频资产记录**的集合。系统获取每条记录的摘要信息（包括标题、时长、大小、当前**转码状态**及上传时间）。
3. **呈现列表**： 系统向管理员提供检索到的视频库列表。
4. **发起上传请求**： 管理员向系统提交上传新视频的请求，包含本地文件流及元数据（标题）。
5. **执行子流 S1：验证与接收文件**。 *(注：此处调用子流处理复杂的上传验证逻辑)*
6. **创建资产记录**： 系统在**视频库**中创建一条新的**视频资产记录**，将其状态初始化为“转码中”，并将其关联至当前房间。
7. **请求转码**： 系统向外部参与者**片源转码服务**发送异步处理请求，传递原始文件路径及目标流媒体格式参数（HLS）。
8. **确认任务启动**： 系统接收**片源转码服务**返回的任务确认回执。
9. **更新视图**： 系统向管理员确认操作成功，并刷新视频库列表以显示新添加的记录（状态为处理中）。
10. 用例结束。

### *备选流* 

**A1. 删除视频资产 **

- *触发条件*：在基本流步骤 3 之后，管理员选择删除某个特定的视频。

1. 系统验证该视频是否正在“当前播放”状态。
   - 若正在播放，系统拒绝删除并提示“无法删除正在播放的视频”，流程结束。
2. 系统提示管理员确认删除操作（防止误操作）。
3. 管理员确认删除。
4. 系统执行物理删除操作：移除磁盘上的原始文件及转码后的流媒体切片文件。
5. 系统执行逻辑删除操作：销毁对应的**视频资产记录**。
6. 系统更新剩余存储配额信息。
7. 系统刷新视频库列表，该视频不再可见。
8. 用例结束。

**A2. 查询与过滤**

- *触发条件*：在基本流步骤 3 之后，管理员输入关键词搜索或请求按时间/状态排序。

1. 系统根据管理员提供的过滤条件（如“标题包含X”或“仅显示转码失败项”）重新检索**视频资产记录**。
2. 系统返回过滤后的结果集。
3. 流程返回基本流步骤 3（管理员可基于新列表继续操作）。



**A3.存储空间不足**

1. 在执行子流 S1 期间，系统检测到剩余空间不足以存放新文件。
视频库的一种视图表现形式。它包含多个视频资产记录的摘要，支持排序和过滤，供管理员进行维护操作。
2. 系统拒绝接收数据，并终止上传任务。

3. 系统向管理员报告“存储空间不足”错误。

4. 流程返回基本流步骤 3。

   

**A4. 文件格式不合规**

1. 在**子流S1.验证格式**中，系统检测到文件扩展名不在白名单内，或实际文件头与扩展名不符（伪造格式）。

2. 系统终止处理，不保存任何数据。

3. 系统记录安全警告日志，并向用户返回“不支持的文件格式”错误。

4. 用例结束（失败）。

   

**A5. 完整性校验失败**

1. 在**子流S1.验证与接收文件**步骤步骤 4 中，计算出的校验和与预期不符

2. 系统删除已接收的损坏文件。

3. 系统向用户报告“网络传输错误”并建议重试。

   

### *子流*

**S1.验证与接收文件**

1. **验证权限**：系统验证当前用户是否仍具有上传权限及剩余上传配额。
2. **验证格式**：系统读取文件头，确认文件格式符合视频白名单（如 MP4, MKV），且文件大小未超限。
3. **数据传输**：系统开始接收并写入二进制数据流。
4. **完整性校验**：传输完成后，系统计算并比对文件校验和，确保文件完整。
   - *若任一步骤验证失败，系统抛出异常，触发相应的错误处理备选流。*
5. 返回调用点

### *后置条件*

- **无变更**：若操作取消或失败，视频库状态保持不变。
- **成功添加**：系统物理存储了新文件，并创建了状态为“转码中”的**视频资产记录**。
- **成功删除**：指定的视频文件及相关元数据已从系统中永久移除，存储空间已释放。

---
# UC-06管理成员 

## 简要描述
本用例描述了**房间管理员**（或房主扮演此角色）如何维护房间内的聊天与观影秩序。管理员可以踢出违规用户、限制特定用户的发言权限，或设置全局禁言模式。

## 参与者
- **发起参与者**：房间管理员 
- **受影响对象**：观众

## 前置条件
- 管理员已登录并进入房间。
- 管理员拥有有效的管理权限（未被降级）。

## 基本事件流 
*(场景：管理员踢出一名违规观众)*

1. **用例启动**：管理员在成员列表中选择一名目标观众并请求管理，用例启动。
2. **展示选项**：系统显示对该目标可执行的操作（踢出、禁言）。
3. **选择操作**：管理员选择“踢出用户 (Kick)”。
4. **权限验证**：系统验证目标用户的身份等级。
   - *业务规则：管理员不可踢出房主或其他管理员。*
5. **执行踢出**：
   - 系统强制断开目标观众的连接。
   - 系统将目标观众加入“临时黑名单”（防止立即重连）。
6. **通知全员**：系统在聊天区发布“某用户已被移出房间”的系统消息。
7. **刷新列表**：系统更新房间成员列表，移除该用户。
8. **用例结束**。

## 备选事件流 

### A1. 管理发言权限
* **触发条件**：在基本流步骤 3，管理员选择“禁言/解除禁言”。
1. 管理员设定禁言时长（如：10分钟、永久）。
2. 系统更新该观众的发言状态。
3. 系统向该观众发送通知：“您已被管理员禁言”。
4. 系统刷新成员列表以显示禁言图标。
5. 用例结束。

### A2. 设置全局聊天模式 
* **触发条件**：管理员请求更改房间的整体聊天设置。
1. 管理员选择模式（全员禁言 / 仅管理员发言 / 自由发言）。
2. 系统更新房间的全局状态配置。
3. 系统向所有在线成员广播状态变更通知。
4. 用例结束。

### A3. 权限不足
* **触发条件**：在基本流步骤 4，管理员试图操作房主或其他管理员。
1. 系统拦截操作。
2. 系统向管理员显示错误提示：“权限不足：无法操作同级或上级成员”。
3. 用例结束（失败）。

### A4. 目标用户已离开 
* **触发条件**：在基本流步骤 4，系统检测到目标用户 ID 已不在当前房间列表中。
1. 系统提示“用户已离开房间”。
2. 系统自动刷新成员列表。
3. 用例结束。

### A5. 网络异常处理
* **触发条件**：在与服务器交互的任意步骤发生超时。
1. 系统提示“网络请求超时，请重试”。
2. 系统允许管理员点击重试或取消操作。

## 后置条件
- **踢出**：目标用户与房间断开连接。
- **禁言**：目标用户在指定时间内无法发送消息事件 (Message_Event)。
- **无变更**：若操作失败，成员状态保持不变。

---
---

## UC-07协同观影

| 术语                      | 定义                                                         |
| ------------------------- | ------------------------------------------------------------ |
| **Sync_Event (同步事件)** | 系统内部传递的一种控制指令包，用于强制统一房间内的播放状态。包含指令类型（SEEK, PAUSE, PLAY, CHANGE_RATE, CHANGE_SOURCE等）和参数Payload（时间戳/速率/视频源） |
| **CHANGE_RATE (变速)**    | `Sync_Event` 类型。管理员修改了播放速率。Payload 包含新的速率因子（如 1.5, 2.0）。客户端接收后必须调整本地播放器的 播放速率。 |
| **SEEK (跳转)**           | `Sync_Event` 类型。Payload 包含目标时间戳（毫秒）。          |
| **PAUSE / PLAY (启停)**   | `Sync_Event` 类型。指示播放器暂停或开始。                    |
| **CHANGE_SOURCE (换源)**  | `Sync_Event` 类型。管理员更换了播放内容。Payload 包含新的视频 URL、视频标题及初始字幕信息。客户端接收后需重置播放器并加载新资源。 |
| **同步阈值 **             | 系统允许的最大时间误差值（例如 2000 毫秒）。超过此值的偏差被视为“不同步”，必须触发强制跳转逻辑。 |
| **本地属性 **             | 指音量和 清晰度。这些属性由观众端独立控制，系统严禁将其同步给其他用户。 |
| **房间状态对象 **         | 服务器维护的关于房间当前情况的唯一真实数据集合，用于新用户进房时的初始化同步。（包含：正在播放的视频资源标识、全局基准时间戳、当前播放状态、当前字幕轨道） |

### *简要描述*

- 本用例描述了观众如何在房间内与他人保持同步的观影体验。系统确保所有观众的视频播放进度、播放状态（播放/暂停）、倍速以及字幕选择始终与房间管理员的操作保持一致，从而模拟线下电影院的共时体验。同时，用例允许观众根据自身网络环境独立调整本地视听质量（音量和清晰度），而不干扰房间内的统一播放状态。

### *参与者*

- **房间管理员**：控制视频播放（如播放/暂停、跳转进度）、管理字幕设置，并作为同步信号触发者。

- **观众**：观看视频的同时接收来自服务器的同步指令，但可调整本地视听参数（如音量、清晰度）。

### *前置条件*

- 观众已成功加入观影室。
- 观众客户端与服务器建立了活跃的实时通信连接。

### *基本流*

1. **用例启动**：当观众的浏览器完成播放器组件的加载时，用例启动
2. **初始化房间状态**：系统检索当前房间的`房间状态对象`
3. 系统根据获取的**房间状态对象**初始化本地播放器：
   - 加载指定的视频资源
   - 加载字幕
   - 将进度设定至指定时间
   - 设置播放倍速
4. **执行子流 S1：应用本地偏好设置**
5. **进入同步监听状态**： 系统开始播放（或暂停）视频，并进入持续监听状态，等待接收 **Sync_Event**（同步事件）。
6. **执行子流S2:  处理同步指令**
7. **上报同步状态**: 系统定期生成包含当前本地进度和缓冲状态的**心跳数据**，并将其发送至服务端，以便服务端监控同步误差。
8. **用例结束**： 当观众主动断开连接或离开房间时，用例结束。



### *备选流*

**A1.视频资源失效**

1. 在基本流步骤3中，系统无法加载视频资源。
2. 系统向观众显示错误提示：“视频源不可用”。
3. 系统保持在房间内，但禁用播放器控件。



**A2. 网络延迟过大导致的不同步**

1. 在基本流步骤 8 中，系统计算出 `本地时间戳` 与 `目标时间戳` 的差值超过 **同步阈值 (例如 2秒)** 。
2. 系统强制执行“Seek”操作，跳转至 `目标时间戳`。
3. 系统在界面显示“正在同步...”提示。



### *子流*

 **S1.应用本地偏好设置**

 1.  系统读取观众预设的**本地属性**（音量偏好、清晰度偏好）。
 2.  系统将播放音量设定为预设值。
 3.  系统尝试加载偏好清晰度（如 1080P）的视频流；若该清晰度不可用，则回退至默认清晰度。
 4.  返回调用点。

​	*注：此子流中的操作仅改变本地状态，不触发 Sync_Event 广播* 。

**S2.处理同步指令**

1. 系统解析 **Sync_Event** 的类型和负载数据。
2. **IF** 事件类型为 **PAUSE**：
   - 系统立即停止视频渲染。
3. **IF** 事件类型为 **PLAY**：
   - 系统恢复视频播放。
4. **IF** 事件类型为 **SEEK**：
   - 系统验证目标时间戳有效性。
   - 系统强制将播放进度重置为目标时间戳。
5. **IF** 事件类型为 **CHANGE_RATE**：
   - 系统调整播放速率。
6. **IF** 事件类型为 **CHANGE_SUBTITLE**：
   - 系统加载新的字幕资源。
7. 流程返回调用点（继续监听）。

### *后置条件*

- 系统断开通信连接，并停止上报心跳数据。

---

## UC-08参与互动

## 1: 简要描述
参与者创建并且发送消息(文本、语音、表情)到聊天室，并且接收其他参与者的消息，发送和接收的消息会

## 2参与者
* 观众

## 3前置条件
* 参与者必须加入到观影厅
* 与观影厅之间的连接是有效的
* 系统能够对消息进行处理
* 必须能够使用发送消息“服务选项”(服务选项是可出现术语表之中的内容，这里暂且将其定义为：参与者进入观影厅后，系统提供的可操作项，例如调节音量、清晰度等)

## 4基本流
**{进入观影厅}**
1. 当参与者观众进入观影厅时，开始启动用例。
2. 系统展示观影厅中各种“服务选项”

**{等待事件}**
3. 系统等待以下事件发生：
    * 观众选择发送消息。
    * 观众离开观影厅。

**{处理事件}**
4. 系统根据对应事件，执行对应流程：
    * 观众选择发送消息，跳转至 **发送信息** 。
    * 观众离开观影厅，跳转至 **用例终止** 。

**{发送消息}**
5. 系统进入消息输入界面。

**{编辑消息}**
6. 观众在消息输入框中编辑消息内容：
    * 文本消息：直接输入。
    * 语音消息：点击语音按钮输入。
    * 表情消息：选择表情后输入。

**{发送消息}**
7. 观众点击发送按钮。
8. 系统接收输入消息，并且执行子流“验证消息内容”。
9. 系统执行子流“广播消息”。
10. 用例跳转至 **{等待事件}** 。

**{用例终止}**
11. 当观众离开观影厅时，用例终止。

## 5: 备选流

### 5.1: 消息的接收
**5.1.1: 接收聊天室的消息**
在 **进入观影厅** 后的任意过程中，当有观众发送消息，则：
1. 系统将最新消息发送给当前观众。
2. 系统将该消息展示到聊天室消息列表末尾。
3. 系统显示发送者身份信息、发送时间。
4. 用例返回原执行点。

**5.1.2: 接收弹幕的消息**
在 **{进入观影厅}** 后的任意过程中，当有观众发送消息，则：
1. 系统检查当前观众的弹幕功能是否开启。
    * a: 弹幕功能开启，系统将最新的消息展示到屏幕上。
    * b: 弹幕功能关闭，则不展示消息到屏幕。
2. 用例返回原执行点。

### 5.2: 消息内容的处理
**5.2.1: 处理验证失败的消息**
**【发送消息】** 步骤8中的“验证消息内容”如果失败，则：
1. 系统阻止消息发送，并且在输入框附近显示对应的错误提示。
2. 用例重新回到基本流的 **编辑消息** 处。

**5.2.2: 处理特殊类型的消息**
**【发送消息】** 步骤8中的“接收输入消息”如果接收是非纯文本消息，则：
1. 系统判断消息类型并匹配对应展示格式。
    * a: 语音消息，聊天室中正常显示，弹幕展示带有时长数字的语音图标。
    * b: 表情消息，聊天室中正常显示，弹幕展示合适尺寸的表情。
    * c: 文字+表情复合消息，聊天室中正常显示，弹幕展示正常文字+合适尺寸的表情。
2. 用例继续执行。

### 5.3: 弹幕功能的开关
**5.3.1: 切换弹幕功能的状态**
在用例执行过程中，观众只要点击观影厅中的弹幕功能开关按钮，则：
1. 系统检测当前弹幕功能的开关状态。
2. 系统切换弹幕功能的开关状态。

## 6: 子流

### 6.1: 验证消息内容
1. 系统检查消息长度是否超限(文字<=200字，语音<=60s)。
2. 系统检查消息格式兼容性(表情文件大小)。
3. 系统返回验证结果。

### 6.2: 广播消息
1. 系统获取当前观影厅聊天室中的观众列表。
2. 系统将消息发送给所有观众。
3. 系统跟踪消息的发送状态。
    * a: 发送失败：进行有限次数的重新发送。
    * b: 发送成功：用例继续执行。

## 7: 后置条件
系统存储观影厅内的聊天记录。

## 8: 公共扩展点
无

## 9: 特殊需求
**实时性**
消息在聊天室、弹幕中的显示与消息发送的延迟不应该超过500ms。

**一致性**
消息在聊天室、弹幕中的显示应与发送的消息一致(语音消息除外)。
